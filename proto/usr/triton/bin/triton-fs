#!/bin/bash
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
#
# Copyright 2020 Joyent Inc.
#

#
# This script gets called by systemd for the triotn-fs.service start up. It
# mainly exists as somewhat-anaalog to the fs-joyent service on SmartOS.
# On Linux, importing ZFS is handled for us, but we need to support the
# following:
#
# * Identify the system pool
# * noimport
# * factory reset
#

# This is here just to show us what the state of the system is in the journal
set -o xtrace
zpool status
zfs list
mount | grep zones
systemctl status
systemctl -a | grep zfs | grep -v device
systemctl -a | grep triton

set -o errexit
set -o pipefail
set -o xtrace

# First import all pools.
zpool import -aN -o cachefile=none

# Assume the system zpool is zones, but if a different system pool
# identifies itself (by virtue of the .system_pool file being present in the
# pool's root dataset), then use that system pool instead.
SYS_ZPOOL=zones
mapfile -t all_pools < <(zpool list -Ho name)

for pool in "${all_pools[@]}"; do
    if [[ -f /${pool}/.system_pool ]]; then
        mkdir -p /run/triton
        ln -s "/${pool}/" /run/triton/system_pool
        SYS_ZPOOL="$pool"
    fi
done

if (( ${#all_pools[@]} < 1 )); then
    printf 'No pools. Exiting.\n'
    exit 0
fi

# Deal with noimport
# Because we're being called after zfs-import.target, the pool (if it exists)
# will already be imported. In this case, we'll simply unmount it.
if grep -q -w noimport=true /proc/cmdline ; then
    zpool export "$SYS_ZPOOL"
    # If we're not importing the pool, we don't want to do anything that comes
    # later in this script
    exit 0
fi

# Danger zone
function destroy_zpools
{
    for pool in "${all_pools[@]}" ; do
        zpool destroy -f "${pool}"
    done
    exit 0
}

# If the destroy_zpools boot parameter is set, destroy all zpools
if grep -q -w 'destroy_zpools=true' /proc/cmdline ; then
    printf 'destroy_pools kernel command detected.\n'
    destroy_zpools
fi

# A machine is reset to its original unsetup state (i.e. a 'factory reset')
# when the smartdc:factoryreset ZFS user property is set on the var dataset.
reset=$(zfs get -H -o value smartdc:factoryreset "${SYS_ZPOOL}/var")
if [ "${reset}" == "yes" ]; then
    printf '%s/var dataset has factoryrest property.\n' "${SYS_ZPOOL}"
    destroy_zpools
fi

# If we're here, then we're in a normal boot up. Do some housekeeping taks
#
if [[ -f /zones/global/cores ]]; then
    ln -s /zones/global/cores /cores
fi

# Now export all pools so we're clean before the systemd zfs target.
for pool in "${all_pools[@]}"; do
    zpool export "$pool"
done
